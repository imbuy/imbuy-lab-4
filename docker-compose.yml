version: '3.8'

services:
  # Базы данных

  postgres-user:
    image: postgres:14
    container_name: postgres-user
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: imbuy
      POSTGRES_PASSWORD: secret
      TZ: Europe/Moscow
    ports:
      - "5433:5432"
    volumes:
      - postgres_user_data:/var/lib/postgresql/data
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imbuy -d user_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-category:
    image: postgres:14
    container_name: postgres-category
    environment:
      POSTGRES_DB: category_db
      POSTGRES_USER: imbuy
      POSTGRES_PASSWORD: secret
      TZ: Europe/Moscow
    ports:
      - "5434:5432"
    volumes:
      - postgres_category_data:/var/lib/postgresql/data
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imbuy -d category_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-lot:
    image: postgres:14
    container_name: postgres-lot
    environment:
      POSTGRES_DB: lot_db
      POSTGRES_USER: imbuy
      POSTGRES_PASSWORD: secret
      TZ: Europe/Moscow
    ports:
      - "5435:5432"
    volumes:
      - postgres_lot_data:/var/lib/postgresql/data
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imbuy -d lot_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-bid:
    image: postgres:14
    container_name: postgres-bid
    environment:
      POSTGRES_DB: bid_db
      POSTGRES_USER: imbuy
      POSTGRES_PASSWORD: secret
      TZ: Europe/Moscow
    ports:
      - "5436:5432"
    volumes:
      - postgres_bid_data:/var/lib/postgresql/data
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imbuy -d bid_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-notification:
    image: postgres:14
    container_name: postgres-notification
    environment:
      POSTGRES_DB: notification_db
      POSTGRES_USER: imbuy
      POSTGRES_PASSWORD: secret
      TZ: Europe/Moscow
    ports:
      - "5437:5432"
    volumes:
      - postgres_notification_data:/var/lib/postgresql/data
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imbuy -d notification_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-file:
    image: postgres:14
    container_name: postgres-file
    environment:
      POSTGRES_DB: file_db
      POSTGRES_USER: imbuy
      POSTGRES_PASSWORD: secret
      TZ: Europe/Moscow
    ports:
      - "5438:5432"
    volumes:
      - postgres_file_data:/var/lib/postgresql/data
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imbuy -d file_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Zookeeper для Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka Broker 1
  kafka-1:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-1
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "19092:19092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-1:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:29092"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka Broker 2
  kafka-2:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-2
    depends_on:
      - zookeeper
    ports:
      - "9093:9093"
      - "19093:19093"
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-2:29093,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:29093"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka Broker 3
  kafka-3:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-3
    depends_on:
      - zookeeper
    ports:
      - "9094:9094"
      - "19094:19094"
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-3:29094,PLAINTEXT_HOST://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:29094"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Discovery Server
  discovery-server:
    build:
      context: .
      dockerfile: discovery-server/Dockerfile
    container_name: discovery-server
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=default
      - TZ=Europe/Moscow
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Config Server
  config-server:
    build:
      context: .
      dockerfile: config-server/Dockerfile
    container_name: config-server
    ports:
      - "8888:8888"
    environment:
      - SPRING_PROFILES_ACTIVE=native
      - TZ=Europe/Moscow
    depends_on:
      - discovery-server
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8888/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
  # User Service
  user-service:
    build:
      context: .
      dockerfile: user-service/Dockerfile
    container_name: user-service
    environment:
      - SERVER_PORT=0
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-user:5432/user_db
      - SPRING_DATASOURCE_USERNAME=imbuy
      - SPRING_DATASOURCE_PASSWORD=secret
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - TZ=Europe/Moscow
    depends_on:
      postgres-user:
        condition: service_healthy
      discovery-server:
        condition: service_started
      config-server:
        condition: service_started
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Category Service
  category-service:
    build:
      context: .
      dockerfile: category-service/Dockerfile
    container_name: category-service
    environment:
      - SERVER_PORT=0
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-category:5432/category_db
      - SPRING_DATASOURCE_USERNAME=imbuy
      - SPRING_DATASOURCE_PASSWORD=secret
      - SPRING_R2DBC_URL=r2dbc:postgresql://postgres-category:5432/category_db
      - SPRING_R2DBC_USERNAME=imbuy
      - SPRING_R2DBC_PASSWORD=secret
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - TZ=Europe/Moscow
    depends_on:
      postgres-category:
        condition: service_healthy
      discovery-server:
        condition: service_started
      config-server:
        condition: service_started
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Lot Service
  lot-service:
    build:
      context: .
      dockerfile: lot-service/Dockerfile
    container_name: lot-service
    environment:
      - SERVER_PORT=0
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-lot:5432/lot_db
      - SPRING_DATASOURCE_USERNAME=imbuy
      - SPRING_DATASOURCE_PASSWORD=secret
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - TZ=Europe/Moscow
    depends_on:
      postgres-lot:
        condition: service_healthy
      discovery-server:
        condition: service_started
      config-server:
        condition: service_started
      user-service:
        condition: service_started
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
  # Bid Service
  bid-service:
    build:
      context: .
      dockerfile: bid-service/Dockerfile
    container_name: bid-service
    environment:
      - SERVER_PORT=0
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-bid:5432/bid_db
      - SPRING_DATASOURCE_USERNAME=imbuy
      - SPRING_DATASOURCE_PASSWORD=secret
      - SPRING_R2DBC_URL=r2dbc:postgresql://postgres-bid:5432/bid_db
      - SPRING_R2DBC_USERNAME=imbuy
      - SPRING_R2DBC_PASSWORD=secret
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - TZ=Europe/Moscow
    depends_on:
      postgres-bid:
        condition: service_healthy
      discovery-server:
        condition: service_started
      config-server:
        condition: service_started
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - TZ=Europe/Moscow
    depends_on:
      - discovery-server
      - config-server
      - user-service
      - category-service
      - lot-service
      - bid-service
      - notification-service
      - file-service
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Notification Service
  notification-service:
    build:
      context: .
      dockerfile: notification-service/Dockerfile
    container_name: notification-service
    environment:
      - SERVER_PORT=0
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-notification:5432/notification_db
      - SPRING_DATASOURCE_USERNAME=imbuy
      - SPRING_DATASOURCE_PASSWORD=secret
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-1:29092,kafka-2:29093,kafka-3:29094
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - TZ=Europe/Moscow
    depends_on:
      postgres-notification:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
      kafka-2:
        condition: service_healthy
      kafka-3:
        condition: service_healthy
      discovery-server:
        condition: service_started
      config-server:
        condition: service_started
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # File Service
  file-service:
    build:
      context: .
      dockerfile: file-service/Dockerfile
    container_name: file-service
    environment:
      - SERVER_PORT=0
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-file:5432/file_db
      - SPRING_DATASOURCE_USERNAME=imbuy
      - SPRING_DATASOURCE_PASSWORD=secret
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-1:29092,kafka-2:29093,kafka-3:29094
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-server:8888
      - TZ=Europe/Moscow
      - FILE_STORAGE_PATH=/app/files
    depends_on:
      postgres-file:
        condition: service_healthy
      kafka-1:
        condition: service_healthy
      discovery-server:
        condition: service_started
      config-server:
        condition: service_started
    volumes:
      - file_storage:/app/files
    networks:
      - imbuy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8099:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: imbuy
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-1:29092,kafka-2:29093,kafka-3:29094
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    depends_on:
      kafka-1:
        condition: service_healthy
      kafka-2:
        condition: service_healthy
      kafka-3:
        condition: service_healthy
    networks:
      - imbuy-network

networks:
  imbuy-network:
    driver: bridge

volumes:
  postgres_user_data:
  postgres_category_data:
  postgres_lot_data:
  postgres_bid_data:
  postgres_notification_data:
  postgres_file_data:
  file_storage: